!!!
%html
  %head
    %title Расписание #{@course}-го курса СтатМода
    %script{ :src => '/js/redips-drag-source.js' }
    %script{ :src => '/js/redips-table-source.js' }
    %script{ :src => '/js/jquery-1.8.2.min.js'}
    %script{ :src => '/js/jquery.jeditable.mini.js'}
    %script{ :src => '/js/jquery.autocomplete.js'}
    %script{ :src => '/js/underscore-min.js' }
    %script{ :src => '/js/createNewLesson.js' }
    %script{ :src => '/js/saveToXml.js' }
    %link{ :rel => 'stylesheet', :type => 'text/css', :href => '/styles/TimeTable.css'}
    %link{ :rel => 'stylesheet', :type => 'text/css', :href => '/styles/jquery.autocomplete.css'}

    %body
    :javascript

      function makeEditable(classname) {
        $('.' + classname + '.loc').editable(function (value, settings) {
          return(value);
        }, { 
             style: 'display: inline-block',
             data: function(str) { return $.trim(str); },
             placeholder: ''
           });

        $('.' + classname + '.prof').editable(function (value, settings) {
          return(value);
        }, { 
             type: 'autocomplete',
             style: 'display: inline-block', 
             data: function(str) { return $.trim(str); },
             placeholder: '',
             autocomplete: {
               data: #{@@stafflist_json}
             }
           });

        $('.' + classname + '.name').editable(function (value, settings) {
          return(value);
        }, {
          type: 'autocomplete',
          style: 'display: inline-block',
          data: function(str) { return $.trim(str); },
          placeholder: '',
          autocomplete: {
            data: courses[$("#sem").attr('value')]
          }
        });
      }

      courses = #{@@courselist_json};

      $(document).ready(function () {

        $(".DeleteButton").click(function() {
          $(this).parents(".drag").remove();
        });

        $("#newlesson").one("click", createNewLesson);

        REDIPS.drag.enable_table(false, 'LessonTable');
        REDIPS.drag.init();
        REDIPS.drag.drop_option = 'switch';
        REDIPS.table.mark_nonempty = false;
        REDIPS.table.color.cell = '#FFFFDD';
        REDIPS.table.onmousedown('timetable', true);

        $.editable.addInputType('autocomplete', {
          element: $.editable.types.text.element,
          plugin: function(settings, original) {
            $('input', this).autocomplete(settings.autocomplete.data, { matchContains: true});
          }
        });

        makeEditable('editable');

        $('#xmlsaveform').submit(function() {
          $('#xmldata').val(getTimeTableXml());
          return true;
        });

        $('option').click(function ()
        {
          $(this).closest('form').submit();
        });

        $('.FileSelector').prop('selectedIndex', -1);
      });

    %div{ :class => 'uppanel'}
      %input{ :id => 'year', :class => 'YearSelector', :value => @timetable.year }
        %label{ :for => 'year', :class => 'YearLabel' }
          Год
      %input{ :id => 'sem', :class => 'SemesterSelector', :value => @timetable.semester }
        %label{ :for => 'sem', :class => 'SemesterLabel' }
          Семестр

      %form{ :action => '/loadfile', :method => 'post' }
        %select{ :onchange => 'this.form.submit()', :name => 'filename', :class => 'FileSelector' }
          - @@filenames.each do |fn|
            - if fn == @filename
              %option{ :value => fn, :selected => 'selected'}#{fn}
            - else
              %option{ :value => fn}#{fn}
                                 
      %button{ :class => 'MergeButton', :onclick => 'REDIPS.table.merge();' }
        Объединить ячейки

      %button{ :class => 'SplitButton', :onclick => 'REDIPS.table.split();' }
        Разбить ячейки

      %form{ :class => 'SaveForm', :action => '/download', :target => '_blank', :method => 'POST', :id => 'xmlsaveform' }
        %input{ :type => 'hidden', :id => 'xmldata', :name => 'xmldata'}
        %input{ :type => 'hidden', :name => 'filename', :value => @filename }
        %input{ :type => 'submit', :class => 'SaveButton', :value => 'Сохранить в XML' }

    %div{ :id => 'drag' }
      %table{ :id => 'helpertable', :class => 'HelperTable' }
        %tbody
          %tr
            %td{ :style => 'height: 62px', :align => 'center', :id => 'newlesson', :class => 'mark'}
              Нажмите, чтобы создать новую пару
      - specs = ['sm', 'mm', 'sa']
      - specnames = ['СМ', 'ММ', 'САПР']
      %div{ :class => 'empty'}
      %table{ :id => 'timetable', :class => 'TimeTable', :border => '1px' }
        %tbody
          %tr
            %th{ :width => '2%', :class => 'mark', :bgcolor => '#ddddff' }
            - specnames.each do |name|
              %td{ :bgcolor => '#ddddff', :align => 'center', :width => '33%', :class => 'mark' }
                = name
          - @timetable.weekday_tables.each do |weekday|
            %tr
              %th{ :class => 'mark', :bgcolor => '#ffffcd' }

              %th{ :colspan => 3, :bgcolor => '#ffffcd', :class => 'mark' }
                = weekday.name

            - 1.upto(5).each do |index|
              %tr{ :class => weekday.id }
                %th{ :bgcolor => '#f6956f', :style => 'height: 60px', :class => 'mark' }
                  = index

                - double_class = weekday.getDoubleClass(index)
                - dep_lesson = if double_class.nil? then nil else double_class.getLessonForSpec 'all' end
                - if dep_lesson.nil?
                  - specs.each do |spec|
                    %td{ :class => 'lesson' }
                      - unless double_class.nil?
                        - lesson = double_class.getLessonForSpec(spec)
                        - unless lesson.nil?
                          %div{ :class => 'drag' }
                            = haml :lesson, :locals => { :lesson => lesson }
                - else
                  %td{ :colspan => 3, :align => 'center', :class => 'lesson' }
                    - unless dep_lesson.nil?
                      %div{ :class => 'drag' }
                        = haml :lesson, :locals => { :lesson => dep_lesson }
      
